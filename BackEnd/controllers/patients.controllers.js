import { pool } from '../db.js';

export const getPatients = async (req, res) => {
  try {
    const [result] = await pool.query(
      `SELECT p.idPatient, u.dni, u.firstName, u.lastName, ic.name as insuranceCompanyName
       FROM patients p 
       INNER JOIN users u ON u.dni = p.dni 
       INNER JOIN insurance_companies ic ON ic.idInsuranceCompany = u.idInsuranceCompany
       WHERE p.status = 'Habilitado'
       ORDER BY u.lastName, u.firstName`
    );
    if (result.length === 0) {
      return res.json([]); // Return empty array instead of 404
    } else {
      res.json(result);
    }
  } catch (error) {
    return res.status(500).json({ message: error.message });
  }
};

export const getPacienteByDni = async (req, res) => {
  try {
    const { dni } = req.body;

    const [result] = await pool.query(
      `SELECT p.idPatient, u.firstName, u.lastName, u.dni
       FROM patients p
       INNER JOIN users u ON u.dni = p.dni
       WHERE u.dni = ? AND p.status = 'Habilitado'`,
      [dni]
    );

    if (result.length === 0) {
      return res
        .status(404)
        .json({ message: 'Patient not found or not enabled' });
    } else {
      res.json(result[0]);
    }
  } catch (error) {
    return res.status(500).json({ message: error.message });
  }
};

export const createPatient = async (req, res) => {
  const { dni } = req.body;
  const status = 'Habilitado';
  try {
    const [result] = await pool.query(
      'INSERT INTO patients (dni, status) VALUES (?, ?)',
      [dni, status]
    );
    res.json({
      idPatient: result.insertId, // Return the autogenerated id
      dni,
      status: status,
    });
  } catch (error) {
    return res.status(500).json({ message: error.message });
  }
};
